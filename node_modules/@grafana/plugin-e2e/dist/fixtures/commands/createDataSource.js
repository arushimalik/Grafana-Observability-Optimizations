"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createDataSource = exports.createDataSourceViaAPI = void 0;
const uuid_1 = require("uuid");
const test_1 = require("@playwright/test");
const createDataSourceViaAPI = async (request, datasource) => {
    const { type, name } = datasource;
    const dsName = name ?? `${type}-${(0, uuid_1.v4)()}`;
    const existingDataSource = await request.get(`/api/datasources/name/${dsName}`);
    if (await existingDataSource.ok()) {
        const json = await existingDataSource.json();
        await request.delete(`/api/datasources/uid/${json.uid}`);
    }
    const createDsReq = await request.post('/api/datasources', {
        data: {
            ...datasource,
            name: dsName,
            access: 'proxy',
            isDefault: false,
        },
    });
    const text = await createDsReq.text();
    const status = await createDsReq.status();
    if (status === 200) {
        return createDsReq.json().then((r) => r.datasource);
    }
    test_1.expect.soft(createDsReq.ok(), `Failed to create data source: ${text}`).toBeTruthy();
    return existingDataSource.json();
};
exports.createDataSourceViaAPI = createDataSourceViaAPI;
const createDataSource = async ({ request }, use) => {
    await use(async (args) => {
        return (0, exports.createDataSourceViaAPI)(request, args);
    });
};
exports.createDataSource = createDataSource;
